<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- CSS -->
    <link rel="stylesheet" href="globalStyle.css" />
    <link rel="stylesheet" href="CSS/nav.css" />
    <link rel="stylesheet" href="CSS/statusBar.css" />
    <link rel="stylesheet" href="CSS/noticeBar.css" />
    <link rel="stylesheet" href="CSS/farmInfoModal.css" />
    <!-- Pretendard 웹폰트 CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />
    <title>에이티디코리아 악취확산도</title>

    <!-- 네이버 지도 스타일 -->
    <style>
      /* 컴포넌트 로딩 중 깜빡임 방지 */
      .dashboardContainer {
        opacity: 0;
        transition: opacity 0.15s ease-in;
      }
      .dashboardContainer.ready {
        opacity: 1;
      }

      .map-layout {
        position: relative;
        height: 100%;
        width: 100%;
      }

      .legend {
        position: absolute;
        top: 120px;
        left: 20px;
        width: 200px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 2;
        backdrop-filter: blur(5px);
      }

      .legend-title {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 12px;
        color: #333;
        text-align: center;
      }

      .legend-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 6px;
        background: rgba(248, 249, 250, 0.8);
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .legend-item:hover {
        background: rgba(233, 236, 239, 0.9);
        border-color: #1976d2;
        transform: translateX(2px);
      }

      .legend-item.active {
        background: rgba(25, 118, 210, 0.1);
        border-color: #1976d2;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
      }

      .legend-icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        flex-shrink: 0;
      }

      .legend-label {
        font-size: 12px;
        color: #555;
        font-weight: 500;
      }

      .map-panel {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      #map {
        width: 100%;
        height: 100%;
        flex: 1;
      }

      .marker-name-label {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .delete-btn {
        background: #e53935;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        font-size: 11px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .delete-btn:hover {
        background: #c62828;
      }

      .marker-type-label {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        white-space: nowrap;
        pointer-events: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      /* 커스텀 디바이스 팝업 (마커 클릭 시 표시) */
      .device-popup {
        position: absolute;
        width: 320px;
        background: #ffffff;
        border: 2px solid var(--accent, #1976d2);
        border-radius: 16px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25);
        padding: 18px 18px 14px;
        color: #222;
        user-select: none;
        pointer-events: auto;
        transform-origin: 50% 100%;
      }

      /* 테두리 삼각형 (외곽선) */
      .device-popup:after {
        content: '';
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: -16px;
        width: 0;
        height: 0;
        border-left: 14px solid transparent;
        border-right: 14px solid transparent;
        border-top: 16px solid var(--accent, #1976d2);
      }

      /* 테두리 삼각형 내부 (흰색 내용) */
      .device-popup:before {
        content: '';
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: -14px;
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-top: 14px solid #ffffff;
        z-index: 1;
      }

      .popup-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
      }

      .popup-row {
        margin-bottom: 10px;
      }

      .popup-label {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
        color: #222;
      }

      .popup-value {
        font-size: 14px;
        color: #555;
      }

      .popup-chip-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .data-chip {
        background: #f1f3f5;
        color: #333;
        border-radius: 12px;
        padding: 6px 10px;
        font-size: 12px;
        border: 1px solid #e9ecef;
      }

      .popup-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 14px;
        margin-top: 8px;
      }

      .metric .label {
        font-size: 14px;
        color: #222;
        font-weight: 700;
        margin-bottom: 6px;
      }

      .metric .value {
        font-size: 14px;
        color: #555;
      }

      .popup-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
      }

      .popup-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        background: #f8f9fa;
        color: #333;
        cursor: pointer;
      }

      .popup-btn.delete {
        background: #e53935;
        border-color: #e53935;
        color: #fff;
      }

      .device-detail-info {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        font-size: 13px;
        line-height: 1.4;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        max-width: 250px;
      }

      .device-detail-info b {
        color: #1976d2;
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
      }

      .detail-delete-btn {
        background: #e53935;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.2s;
      }

      .detail-delete-btn:hover {
        background: #c62828;
      }

      #markerCountInfo {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }

      /* mapContainer 높이 조정 */
      .mapContainer {
        height: 80vh;
        max-height: 700px;
        width: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* 스크롤 방지 */
      }
    </style>
  </head>

  <body>
    <div id="navContainer"></div>
    <div class="dashboardContainer landscape">
      <div id="statusBar"></div>
      <div id="noticeBar"></div>
      <div class="mapContainer">
        <div class="map-layout">
          <section class="map-panel">
            <!-- 마커 개수 정보 및 버튼들 -->
            <div
              style="
                padding: 15px 20px;
                background: white;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div style="display: flex; gap: 10px">
                <button
                  id="resetAllMarkers"
                  style="
                    padding: 8px 16px;
                    background: #e53935;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background 0.2s;
                  "
                  onmouseover="this.style.background='#c62828'"
                  onmouseout="this.style.background='#e53935'"
                >
                  모든 마커 삭제
                </button>
                <button
                  id="reloadMarkers"
                  style="
                    padding: 8px 16px;
                    background: #1976d2;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background 0.2s;
                  "
                  onmouseover="this.style.background='#1565c0'"
                  onmouseout="this.style.background='#1976d2'"
                >
                  JSON 데이터 로드
                </button>
              </div>
              <div
                id="markerCountInfo"
                style="font-size: 12px; color: #666; text-align: right"
              >
                전체: 0/40 | 악취측정기: 0/15 | 음수투약기: 0/8 | 풍향풍속계:
                0/10 | 게이트웨이: 0/7
              </div>
            </div>
            <div id="map"></div>
          </section>

          <!-- 범례를 지도 위에 겹치게 배치 -->
          <aside class="legend">
            <div class="legend-title"><b>마커 종류</b></div>
            <ul id="legendList" class="legend-list"></ul>
          </aside>
        </div>
      </div>
    </div>

    <!-- 화면 비율 비교 후 landscape, portrait 출력 -->
    <!-- 렌더링 전에 자바스크립트를 불러오기에 정상 동작하지 않음, 렌더링 이후 실행하도록 수정 필요 -->
    <script src="./JS/ScreenRatio.js"></script>

    <!-- 공지사항 애니메이션 스크립트 -->
    <script src="./JS/noticeBar.js"></script>

    <!-- jQuery, Moment.js, Daterangepicker 라이브러리 -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
    />

    <!-- 로딩 컴포넌트 로직 -->
    <script>
      async function loadComponent(componentPath, targetId, callback) {
        const response = await fetch(componentPath);
        const html = await response.text();
        document.getElementById(targetId).innerHTML = html;
        if (callback) callback();
      }

      loadComponent('Components/nav.html', 'navContainer', function () {
        const script = document.createElement('script');
        script.src = './JS/nav.js';
        document.body.appendChild(script);
      });

      loadComponent('Components/statusBar.html', 'statusBar', function () {
        const script = document.createElement('script');
        script.src = './JS/status.js';
        document.body.appendChild(script);
      });

      loadComponent(
        'Components/noticeBar.html',
        'noticeBar',
        runNoticeBarAnimation
      );
    </script>

    <!-- 네이버 지도 관련 스크립트 -->
    <script type="module">
      import CONFIG from './JS/config.js';
      let map = null;
      let mapDeviceManager = null;
      const DEFAULT_ODOR_RADIUS_M = 120; // 악취 확산 반경(미터)
      let odorOverlay = null; // 지도 로드 후 생성
      let currentDeleteLabel = null;

      // 클래스 정의
      class MapDeviceManager {
        constructor(map) {
          this.map = map;
          this.markers = [];
          this.markerIdSeq = 1;
          this.connectionLines = [];
          this.odorOverlay = null; // 악취 확산 오버레이 (로드 후 주입)

          // 마커 개수 제한 설정
          this.maxMarkers = 40; // 전체 최대 마커 개수
          this.maxMarkersPerType = {
            악취측정기: 15,
            음수투약기: 8,
            풍향풍속계: 10,
            게이트웨이: 7,
          };
        }

        // 마커 추가 가능 여부 확인
        canAddMarker(type) {
          // 전체 마커 개수 확인
          if (this.markers.length >= this.maxMarkers) {
            alert(`최대 ${this.maxMarkers}개의 마커만 추가할 수 있습니다.`);
            return false;
          }

          // 타입별 마커 개수 확인
          const currentTypeCount = this.markers.filter(
            (m) => m.type === type
          ).length;
          const maxTypeCount = this.maxMarkersPerType[type];

          if (currentTypeCount >= maxTypeCount) {
            alert(`${type}은(는) 최대 ${maxTypeCount}개만 추가할 수 있습니다.`);
            return false;
          }

          return true;
        }

        addDeviceMarker(device) {
          // 마커 추가 가능 여부 확인
          if (!this.canAddMarker(device.type)) {
            return;
          }

          const icon = this.createDeviceIcon(device.type);
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(device.lat, device.lng),
            map: this.map,
            icon: icon,
            draggable: true,
            zIndex: 10,
          });

          // 마커 위 삭제 버튼
          const deleteLabel = new naver.maps.InfoWindow({
            content: `
              <div class="marker-name-label">
                <button class="delete-btn" onclick="window.deleteMarker(${device.id})">삭제</button>
              </div>
            `,
            borderWidth: 0,
            backgroundColor: 'transparent',
            anchorSize: new naver.maps.Size(0, 0),
            anchorColor: 'transparent',
            pixelOffset: new naver.maps.Point(0, -50),
          });
          deleteLabel.open(this.map, marker);

          currentDeleteLabel = deleteLabel;

          // // 최초 로딩 시 삭제 버튼 자동으로 닫기 (3초 후)
          // setTimeout(() => {
          //   currentDeleteLabel.close();
          // }, 500);

          // 마커 아래 라벨 (장치 종류) - 항상 표시 (OverlayView 사용)
          class TypeLabelOverlay extends naver.maps.OverlayView {
            constructor(position, content) {
              super();
              this.position = position;
              this.content = content;
              this.setMap(map);
            }

            onAdd() {
              const div = document.createElement('div');
              div.className = 'marker-type-label';
              div.innerHTML = this.content;
              div.style.position = 'absolute';
              div.style.zIndex = '15';
              div.style.pointerEvents = 'none';
              this.div = div;
              this.getPanes().overlayLayer.appendChild(div);
              this.draw();
            }

            onRemove() {
              if (this.div && this.div.parentNode) {
                this.div.parentNode.removeChild(this.div);
              }
              this.div = null;
            }

            draw() {
              if (!this.div) return;

              const projection = this.getProjection();
              const point = projection.fromCoordToOffset(this.position);

              // 현재 지도 상태 정보
              const currentMapState = {
                lat: this.position.lat(),
                lng: this.position.lng(),
                zoom: this.getMap().getZoom(),
                size: this.getMap().getSize().toString(), // 지도 크기 변화 감지
              };

              // 지도 상태가 변경되었는지 확인 (위도/경도 + 줌 + 크기)
              if (
                this.cachedMapState &&
                this.cachedMapState.lat === currentMapState.lat &&
                this.cachedMapState.lng === currentMapState.lng &&
                this.cachedMapState.zoom === currentMapState.zoom &&
                this.cachedMapState.size === currentMapState.size
              ) {
                return; // 모든 상태가 같으면 업데이트 생략
              }

              // 캐시 업데이트
              this.cachedMapState = currentMapState;

              // transform을 사용하여 더 빠른 위치 업데이트
              this.div.style.transform = `translate(${
                point.x - this.div.offsetWidth / 2
              }px, ${point.y + 20}px)`;
            }

            setPosition(position) {
              // 위치가 실제로 변경되었는지 확인
              if (
                this.position &&
                this.position.lat() === position.lat() &&
                this.position.lng() === position.lng()
              ) {
                return; // 위치가 같으면 업데이트 안함
              }

              this.position = position;
              this.draw();
            }
          }

          const typeLabel = new TypeLabelOverlay(
            new naver.maps.LatLng(device.lat, device.lng),
            device.name || device.type
          );

          // 센서별 측정 데이터 정보 생성
          const getSensorDataInfo = (type) => {
            switch (type) {
              case '악취측정기':
                return `
                  <b>측정 데이터:</b><br>
                  • Gas 1~4 [ppm]: 암모니아, 황화수소, 이산화탄소, 메탄<br>
                  • 온도<br>
                  • 습도
                `;
              case '음수투약기':
                return `
                  <b>측정 데이터:</b><br>
                  • 순시투입량<br>
                  • 누적투입량
                `;
              case '풍향풍속계':
                return `
                  <b>측정 데이터:</b><br>
                  • 풍향<br>
                  • 풍속
                `;
              case '게이트웨이':
                return `
                  <b>기능:</b><br>
                  • 데이터 수집 및 전송
                `;
              default:
                return '';
            }
          };

          // 커스텀 상세 오버레이 (디자인 반영)
          class DeviceDetailOverlay extends naver.maps.OverlayView {
            constructor(position, data, accentColor, onDelete) {
              super();
              this.position = position;
              this.data = data;
              this.accentColor = accentColor;
              this.onDelete = onDelete;
              this.el = null;
            }

            buildHTML() {
              const dev = this.data.device || {};
              const name = dev.name || dev.type || '-';
              const latStr = typeof dev.lat === 'number' ? dev.lat.toFixed(6) : '-';
              const lngStr = typeof dev.lng === 'number' ? dev.lng.toFixed(6) : '-';
              const now = new Date();
              const timeStr = `${String(now.getFullYear()).slice(2)}/${String(
                now.getMonth() + 1
              ).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}/${String(
                now.getHours()
              ).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:00`;

              // 게이트웨이는 측정 데이터 섹션을 표시하지 않음
              const showMeasure = dev.type !== '게이트웨이';
              const measureSection = showMeasure
                ? `
                <div class="popup-row">
                  <div class="popup-label">측정 데이터</div>
                  <div class="popup-chip-group">
                    <span class="data-chip">가스 1종</span>
                    <span class="data-chip">가스 2종</span>
                    <span class="data-chip">가스 3종</span>
                    <span class="data-chip">가스 4종</span>
                  </div>
                </div>`
                : '';

              return `
                <div class="popup-title">${name}</div>
                <div class="popup-row">
                  <div class="popup-label">시간</div>
                  <div class="popup-value">${timeStr}</div>
                </div>
                <div class="popup-row">
                  <div class="popup-label">농장명</div>
                  <div class="popup-value">-</div>
                </div>
                <div class="popup-row">
                  <div class="popup-label">설치위치</div>
                  <div class="popup-value">-</div>
                </div>
                <div class="popup-row">
                  <div class="popup-label">좌표</div>
                  <div class="popup-value">${latStr}, ${lngStr}</div>
                </div>
                ${measureSection}
                <div class="popup-metrics">
                  <div class="metric"><div class="label">온도</div><div class="value">-</div></div>
                  <div class="metric"><div class="label">풍향</div><div class="value">-</div></div>
                  <div class="metric"><div class="label">풍속</div><div class="value">-</div></div>
                </div>
                <div class="popup-actions">
                  <button class="popup-btn popup-close">닫기</button>
                  <button class="popup-btn delete popup-delete">삭제</button>
                </div>
              `;
            }

            onAdd() {
              const div = document.createElement('div');
              div.className = 'device-popup';
              div.style.setProperty('--accent', this.accentColor || '#1976d2');
              div.innerHTML = this.buildHTML();
              this.el = div;
              this.getPanes().floatPane.appendChild(div);
              this.draw();

              const closeBtn = div.querySelector('.popup-close');
              const deleteBtn = div.querySelector('.popup-delete');
              if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); this.setMap(null); });
              if (deleteBtn) deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (this.onDelete) this.onDelete(); });
              
              // 줌 변경 시 재배치/스케일
              const map = this.getMap();
              if (map && !this._zoomListener) {
                this._zoomListener = map.addListener('zoom_changed', () => this.draw());
              }
            }

            onRemove() {
              if (this.el && this.el.parentNode) this.el.parentNode.removeChild(this.el);
              this.el = null;
              // 리스너 해제
              const map = this.getMap();
              if (map && this._zoomListener) {
                naver.maps.Event.removeListener(this._zoomListener);
                this._zoomListener = null;
              }
            }

            draw() {
              if (!this.el) return;
              const proj = this.getProjection();
              const pt = proj.fromCoordToOffset(this.position);
              const w = this.el.offsetWidth;
              const h = this.el.offsetHeight;
              // 줌 레벨에 따른 스케일 계산 (기준 18, 멀어질수록 축소)
              const map = this.getMap();
              const baseZoom = 18;
              const zoom = map ? map.getZoom() : baseZoom;
              let scale = Math.pow(0.92, Math.abs(zoom - baseZoom));
              scale = Math.max(0.6, Math.min(1, scale));

              this.el.style.transform = `translate(${pt.x - w / 2}px, ${pt.y - h - 22}px) scale(${scale})`;
            }

            setPosition(position) {
              this.position = position;
              this.draw();
            }

            setData(data) {
              this.data = data;
              if (this.el) this.el.innerHTML = this.buildHTML();
            }
          }

          const { stroke } = this.getTypeColors(device.type);
          const detailOverlay = new DeviceDetailOverlay(
            new naver.maps.LatLng(device.lat, device.lng),
            { device },
            stroke,
            () => window.deleteMarker(device.id)
          );

          // 마커 클릭 시 상세 정보 토글
          let detailOpen = false;
          marker.addListener('click', () => {
            if (!detailOpen) {
              detailOverlay.setMap(this.map);
              detailOpen = true;
            } else {
              detailOverlay.setMap(null);
              detailOpen = false;
            }
          });

          // 마커 드래그 시 라벨/연결선 동기화 (최적화 + 캐싱)
          let lastDragPosition = null;
          marker.addListener('drag', (e) => {
            requestAnimationFrame(() => {
              const newPosition = marker.getPosition();

              // 위치가 실제로 변경되었는지 확인
              if (
                lastDragPosition &&
                lastDragPosition.lat() === newPosition.lat() &&
                lastDragPosition.lng() === newPosition.lng()
              ) {
                return; // 위치가 같으면 업데이트 안함
              }

              lastDragPosition = newPosition;
              device.lat = newPosition.lat();
              device.lng = newPosition.lng();

              // 라벨 위치 업데이트 (즉시)
              deleteLabel.setPosition(newPosition);
              typeLabel.setPosition(
                new naver.maps.LatLng(device.lat, device.lng)
              );
              // 팝업 위치 즉시 반영
              detailOverlay.setPosition(newPosition);
            });
          });

          // 마커 드래그가 끝난 후 무거운 작업들 처리
          marker.addListener('dragend', () => {
            // 팝업 내용 업데이트(좌표 등)
            detailOverlay.setData({ device });

            // 연결선과 악취 확산 업데이트
            this.updateConnections();
          });

          // 전역 삭제 함수 등록
          window.deleteMarker = (id) => {
            const targetMarker = this.markers.find((m) => m.id === id);
            if (targetMarker) {
              targetMarker.marker.setMap(null);
              targetMarker.deleteLabel.close();
              targetMarker.typeLabel.setMap(null);
              if (targetMarker.detailOverlay) targetMarker.detailOverlay.setMap(null);
              this.markers = this.markers.filter((m) => m.id !== id);
              this.updateConnections();
              this.updateMarkerCountInfo();
            }
          };

          this.markers.push({
            ...device,
            marker,
            deleteLabel,
            typeLabel,
            detailOverlay,
          });
          this.updateConnections();
          this.updateMarkerCountInfo();
        }

        // 마커 개수 정보 업데이트
        updateMarkerCountInfo() {
          const countInfo = document.getElementById('markerCountInfo');
          if (!countInfo) return;

          const totalCount = this.markers.length;
          const odorCount = this.markers.filter(
            (m) => m.type === '악취측정기'
          ).length;
          const waterCount = this.markers.filter(
            (m) => m.type === '음수투약기'
          ).length;
          const windCount = this.markers.filter(
            (m) => m.type === '풍향풍속계'
          ).length;
          const gatewayCount = this.markers.filter(
            (m) => m.type === '게이트웨이'
          ).length;

          countInfo.innerHTML = `
            전체: ${totalCount}/${this.maxMarkers} | 
            악취측정기: ${odorCount}/${this.maxMarkersPerType['악취측정기']} | 
            음수투약기: ${waterCount}/${this.maxMarkersPerType['음수투약기']} | 
            풍향풍속계: ${windCount}/${this.maxMarkersPerType['풍향풍속계']} | 
            게이트웨이: ${gatewayCount}/${this.maxMarkersPerType['게이트웨이']}
          `;

          // 제한에 가까워지면 색상 변경
          if (totalCount >= this.maxMarkers * 0.8) {
            countInfo.style.color = '#e53935';
          } else if (totalCount >= this.maxMarkers * 0.6) {
            countInfo.style.color = '#f57c00';
          } else {
            countInfo.style.color = '#666';
          }
        }

        updateConnections() {
          // 기존 연결선 제거
          this.connectionLines.forEach((line) => line.setMap(null));
          this.connectionLines = [];
          // 게이트웨이와 다른 노드 연결
          const gateways = this.markers.filter((m) => m.type === '게이트웨이');
          const others = this.markers.filter((m) => m.type !== '게이트웨이');

          console.log('연결선 업데이트:', {
            gateways: gateways.length,
            others: others.length,
          });

          gateways.forEach((gateway) => {
            others.forEach((other) => {
              // 마커의 현재 위치를 가져와서 연결선 생성
              const gatewayPos = gateway.marker.getPosition();
              const otherPos = other.marker.getPosition();
              const line = new naver.maps.Polyline({
                path: [
                  new naver.maps.LatLng(gatewayPos.lat(), gatewayPos.lng()),
                  new naver.maps.LatLng(otherPos.lat(), otherPos.lng()),
                ],
                strokeColor: '#e53935',
                strokeWeight: 3,
                strokeOpacity: 0.8,
                strokeStyle: 'dashed',
                map: this.map,
                zIndex: 5,
              });
              this.connectionLines.push(line);
              console.log('연결선 생성:', gateway.type, '->', other.type);
            });
          });
        }

        getTypeColors(type) {
          let fill = '#1976d2';
          let stroke = '#1565c0';

          if (type === '게이트웨이') {
            fill = '#43a047';
            stroke = '#2e7d32';
          } else if (type === '음수투약기') {
            fill = '#ff9800';
            stroke = '#f57c00';
          } else if (type === '풍향풍속계') {
            fill = '#9c27b0';
            stroke = '#7b1fa2';
          } else if (type === '악취측정기') {
            fill = '#2196f3';
            stroke = '#1976d2';
          }

          return { fill, stroke };
        }

        createDeviceIcon(type) {
          const size = 36;
          const canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          ctx.lineWidth = 2;
          const { fill, stroke } = this.getTypeColors(type);

          ctx.strokeStyle = stroke;
          ctx.fillStyle = fill;

          if (type === '악취측정기') {
            // 원형 아이콘 (기존 악취측정기와 동일)
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2 - 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
          } else if (type === '풍향풍속계') {
            // 삼각형 아이콘 (기존 풍향계와 동일)
            ctx.beginPath();
            ctx.moveTo(size / 2, 4);
            ctx.lineTo(size - 4, size - 4);
            ctx.lineTo(4, size - 4);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
          } else if (type === '음수투약기') {
            // 사각형 아이콘 (기존 악취저감장치와 동일)
            ctx.fillRect(4, 4, size - 8, size - 8);
            ctx.strokeRect(4, 4, size - 8, size - 8);
          } else if (type === '게이트웨이') {
            // 마름모 아이콘 (기존과 동일)
            ctx.beginPath();
            ctx.moveTo(size / 2, 4);
            ctx.lineTo(size - 4, size / 2);
            ctx.lineTo(size / 2, size - 4);
            ctx.lineTo(4, size / 2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
          }
          return {
            url: canvas.toDataURL(),
            size: new naver.maps.Size(size, size),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(size / 2, size / 2),
          };
        }

        setOdorOverlay(overlay) {
          // heat 관련 기능 비활성화
          this.odorOverlay = null;
          console.log('악취 확산 오버레이 기능이 비활성화되었습니다.');
        }

        updateOdorOverlay() {
          // heat 관련 기능 비활성화
          console.log('악취 확산 업데이트 기능이 비활성화되었습니다.');
        }
      }

      // 마커 타입 범례 활성화/비활성화 관리
      let activeMarkerType = null;

      function setupLegendClickEvents() {
        const legendItems = document.querySelectorAll('.legend-item');
        legendItems.forEach((item) => {
          item.addEventListener('click', function () {
            const type = this.querySelector('.legend-label').textContent;

            if (activeMarkerType === type) {
              // 같은 타입을 다시 클릭하면 비활성화
              activeMarkerType = null;
              legendItems.forEach((li) => li.classList.remove('active'));
            } else {
              // 다른 타입을 클릭하면 기존 활성화 해제하고 새로 활성화
              legendItems.forEach((li) => li.classList.remove('active'));
              activeMarkerType = type;
              this.classList.add('active');
            }
          });
        });
      }

      // 지도 클릭 이벤트 등록 함수
      function setupMapEvents() {
        if (!map || !mapDeviceManager) return;
        map.addListener('click', function (e) {
          if (!activeMarkerType) {
            // 활성화된 마커 타입이 없으면 아무것도 하지 않음
            return;
          }

          const name = activeMarkerType + ' ' + mapDeviceManager.markerIdSeq;
          mapDeviceManager.addDeviceMarker({
            id: mapDeviceManager.markerIdSeq++,
            type: activeMarkerType,
            name,
            lat: e.coord.lat(),
            lng: e.coord.lng(),
          });
        });
      }

      // 모든 마커 삭제 함수
      function resetAllMarkers() {
        if (!mapDeviceManager) return;

        if (confirm('정말로 모든 마커를 삭제하시겠습니까?')) {
          // 모든 마커 제거
          mapDeviceManager.markers.forEach((marker) => {
            marker.marker.setMap(null);
            marker.deleteLabel.close();
            marker.typeLabel.close();
            marker.detailInfo.close();
          });

          // 마커 배열 초기화
          mapDeviceManager.markers = [];
          mapDeviceManager.markerIdSeq = 1;

          // 연결선 제거 (heat 관련 기능 비활성화)
          mapDeviceManager.connectionLines.forEach((line) => line.setMap(null));
          mapDeviceManager.connectionLines = [];

          // 마커 개수 정보 업데이트
          mapDeviceManager.updateMarkerCountInfo();

          // 활성화된 마커 타입 초기화
          activeMarkerType = null;
          document.querySelectorAll('.legend-item').forEach((item) => {
            item.classList.remove('active');
          });

          alert('모든 마커가 삭제되었습니다.');
        }
      }

      // JSON 데이터에서 마커 다시 로드
      function reloadMarkersFromJson() {
        if (confirm('devices.json에서 마커를 다시 로드하시겠습니까?')) {
          loadDevicesFromJson();
        }
      }

      // devices.json에서 마커 데이터 로드
      async function loadDevicesFromJson() {
        try {
          const response = await fetch('../naver_map/devices.json');
          const devices = await response.json();

          if (!mapDeviceManager) return;

          // 기존 마커 ID 시퀀스 업데이트
          const maxId = Math.max(...devices.map((d) => d.id), 0);
          mapDeviceManager.markerIdSeq = maxId + 1;

          // 각 장치를 마커로 추가
          devices.forEach((device) => {
            // devices.json의 타입을 현재 시스템 타입으로 매핑
            let mappedType = device.type;
            if (device.type === '악취측정기') {
              mappedType = '악취측정기';
            }

            // name이 없으면 type + id로 생성
            const deviceName = device.name || `${mappedType}${device.id}`;

            mapDeviceManager.addDeviceMarker({
              id: device.id,
              type: mappedType,
              name: deviceName,
              lat: device.lat,
              lng: device.lng,
            });
          });

          console.log(`${devices.length}개의 장치 마커가 로드되었습니다.`);
          currentDeleteLabel.close();
        } catch (error) {
          console.error('devices.json 로드 중 오류 발생:', error);
        }
      }

      // 확산도 PNG 파일을 레이어로 추가 (GroundImageOverlay 참조)
      function addOdorDispersionLayer() {
        if (!map) return;

        try {
          // GroundImageOverlay 클래스 정의
          class GroundImageOverlay extends naver.maps.OverlayView {
            constructor(map, imageUrl, bounds, opacity = 0.6) {
              super();
              this.map = map;
              this.imageUrl = imageUrl;
              this.bounds = bounds;
              this.opacity = opacity;
              this.img = null;
              this.setMap(map);
            }

            onAdd() {
              const img = document.createElement('img');
              img.src = this.imageUrl;
              img.style.position = 'absolute';
              img.style.pointerEvents = 'none';
              img.style.opacity = String(this.opacity);
              img.style.transformOrigin = 'top left';
              this.img = img;
              this.getPanes().overlayLayer.appendChild(img);
            }

            onRemove() {
              if (this.img && this.img.parentNode) {
                this.img.parentNode.removeChild(this.img);
              }
              this.img = null;
            }

            setOpacity(opacity) {
              this.opacity = opacity;
              if (this.img) this.img.style.opacity = String(opacity);
            }

            setUrl(url) {
              this.imageUrl = url;
              if (this.img) this.img.src = url;
            }

            setBounds(bounds) {
              this.bounds = bounds;
              this.draw();
            }

            draw() {
              if (!this.img || !this.bounds) return;
              const proj = this.getProjection();
              const sw = proj.fromCoordToOffset(this.bounds.getSW());
              const ne = proj.fromCoordToOffset(this.bounds.getNE());
              const left = sw.x;
              const top = ne.y;
              const width = ne.x - sw.x;
              const height = sw.y - ne.y;
              if (width <= 0 || height <= 0) return;
              const scale = 25; // naver_map.html의 25에서 15로 축소
              const scaledWidth = width * scale;
              const scaledHeight = height * scale;
              const scaledLeft = left - (scaledWidth - width) / 2;
              const scaledTop = top - (scaledHeight - height) / 2;
              this.img.style.transform = `translate(${scaledLeft}px, ${scaledTop}px)`;
              this.img.style.width = `${scaledWidth}px`;
              this.img.style.height = `${scaledHeight}px`;
            }
          }

          // 확산도 이미지 경계 설정 (naver_map.html 참고하여 축소)
          const imageBounds = new naver.maps.LatLngBounds(
            new naver.maps.LatLng(36.60085, 127.296), // 남서쪽 좌표 (더 작은 범위)
            new naver.maps.LatLng(36.60135, 127.29655) // 북동쪽 좌표 (더 작은 범위)
          );

          // GroundImageOverlay 인스턴스 생성
          const odorDispersionOverlay = new GroundImageOverlay(
            map,
            '../naver_map/odor_dispersion.png',
            imageBounds,
            0.6 // 투명도
          );

          console.log('확산도 레이어가 GroundImageOverlay로 추가되었습니다.');
        } catch (error) {
          console.error('확산도 레이어 추가 중 오류 발생:', error);
        }
      }

      // 좌측 범례 생성
      function renderLegend() {
        const legendList = document.getElementById('legendList');
        if (!legendList || !mapDeviceManager) return;
        const items = [
          { type: '악취측정기', label: '악취측정기' },
          { type: '음수투약기', label: '음수투약기' },
          { type: '풍향풍속계', label: '풍향풍속계' },
          { type: '게이트웨이', label: '게이트웨이' },
        ];
        legendList.innerHTML = '';
        items.forEach((item) => {
          const icon = mapDeviceManager.createDeviceIcon(item.type);
          const li = document.createElement('li');
          li.className = 'legend-item';
          const img = document.createElement('img');
          img.className = 'legend-icon';
          img.src = icon.url;
          img.alt = item.label;
          const span = document.createElement('span');
          span.className = 'legend-label';
          span.textContent = item.label;
          li.appendChild(img);
          li.appendChild(span);
          legendList.appendChild(li);
        });
      }

      // 네이버 지도 API 로드 후 map 생성
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${CONFIG.NAVER_MAP_CLIENT_ID2}`;
      document.head.appendChild(script);

      script.onload = () => {
        // heat 관련 기능 비활성화 - OdorHeatmapOverlay 클래스 정의 제거
        var mapOptions = {
          center: new naver.maps.LatLng(36.600699, 127.296352),
          zoom: 18,
          mapTypeId: naver.maps.MapTypeId.HYBRID, // 위성 지도 타입
        };
        map = new naver.maps.Map('map', mapOptions);
        mapDeviceManager = new MapDeviceManager(map);
        // heat 관련 기능 비활성화 - 오버레이 생성하지 않음
        mapDeviceManager.setOdorOverlay(null);
        window.mapDeviceManager = mapDeviceManager;
        setupMapEvents();
        renderLegend();
        setupLegendClickEvents();
        mapDeviceManager.updateMarkerCountInfo();

        // 버튼 이벤트 리스너 연결
        document
          .getElementById('resetAllMarkers')
          .addEventListener('click', resetAllMarkers);
        document
          .getElementById('reloadMarkers')
          .addEventListener('click', reloadMarkersFromJson);

        // devices.json에서 마커 데이터 로드
        loadDevicesFromJson();

        // 확산도 PNG 레이어 추가
        addOdorDispersionLayer();

        // 지도 크기 변경 감지
        map.addListener('resize', () => {
          // 모든 라벨 강제 업데이트
          mapDeviceManager.markers.forEach((marker) => {
            if (marker.typeLabel) {
              marker.typeLabel.draw();
            }
          });
        });

        // 모든 컴포넌트 로드 완료 후 표시
        requestAnimationFrame(() => {
          document.querySelector('.dashboardContainer').classList.add('ready');
        });
      };
    </script>

    <!-- 네비게이션 토글 기능 -->
    <script src="./JS/navToggle.js"></script>
  </body>
</html>
